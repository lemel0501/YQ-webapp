<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YQ_Notifi 設定</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ===== Theme ===== */
    :root {
      --gap: 14px;
      --radius: 14px;
      --pad: 14px;
      --shadow: 0 6px 24px rgba(0,0,0,.08);
      --border: rgba(20,184,166,.18); /* 淺青(藍綠) */
      --teal: #14b8a6;               /* 主色：藍綠 */
      --teal-600: #0ea5a3;
      --muted: #64748b;             /* 次文字色 */
      --ink: #0f172a;               /* 主文字色 */
      --bg-start: #eaf8f6;          /* 背景：淡淡的藍姆綠 */
      --bg-end:   #f7fbfb;          /* 背景：更淡的白青 */
      --card-bg: rgba(255,255,255,.9);
    }

    /* ===== Base ===== */
    html, body { height: 100%; }
    body {
      margin: 0; color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif;
      background: linear-gradient(160deg, var(--bg-start), var(--bg-end));
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
      padding: 18px;
    }

    .container { max-width: 980px; margin: 0 auto; display: grid; gap: var(--gap); }

    /* ===== Header ===== */
    .hero { position: relative; border-radius: 20px; padding: 20px 18px; overflow: hidden; }
    .hero::before {
      content: ""; position: absolute; inset: 0;
      background: radial-gradient(1200px 300px at -10% -40%, rgba(20,184,166,.18), transparent 60%),
                  radial-gradient(900px 300px at 120% 140%, rgba(20,184,166,.16), transparent 60%);
      pointer-events: none;
    }
    .hero h1 { margin: 0 0 6px; font-size: clamp(20px, 3.6vw, 28px); letter-spacing: .3px; }
    .hero p  { margin: 0; color: var(--muted); font-size: 14px; }

    /* ===== Card ===== */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(12px, 2.6vw, 18px);
      backdrop-filter: blur(4px);
    }
    .card h3 { margin: 0 0 10px; letter-spacing: .2px; }
    .grid { display: grid; gap: var(--gap); }

    /* ===== Inputs ===== */
    input[type=text], textarea, select {
      width: 100%; box-sizing: border-box;
      padding: 10px 12px; border-radius: 12px; outline: none;
      border: 1px solid var(--border); background: #fff;
      transition: box-shadow .15s ease, border-color .15s ease;
      font-size: 15px;
    }
    input[type=text]:focus, textarea:focus, select:focus {
      border-color: var(--teal); box-shadow: 0 0 0 3px rgba(20,184,166,.15);
    }

    /* ===== Buttons ===== */
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .spacer { flex: 1; }
    .btn {
      appearance: none; border: none; cursor: pointer; user-select: none;
      padding: 10px 14px; border-radius: 12px; font-weight: 600; font-size: 14px;
      transition: transform .06s ease, filter .15s ease, background .2s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn.teal  { background: var(--teal); color: #fff; }
    .btn.teal:hover { filter: brightness(1.03); }
    .btn.gray  { background: #e5e7eb; color: #111827; }

    .hint { color: var(--muted); font-size: 12px; }

    /* ===== Relay rows (名稱 + 滑桿) ===== */
    .relay-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .rname { min-width: 180px; }

    .switch { position: relative; width: 62px; height: 34px; }
    .switch input[type=checkbox] { position: absolute; opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; inset: 0; background: #d1d5db; border-radius: 999px; transition: background .18s ease; box-shadow: inset 0 1px 2px rgba(0,0,0,.08); }
    .slider:before { content: ""; position: absolute; height: 26px; width: 26px; left: 4px; top: 4px; background: white; border-radius: 50%; transition: transform .18s ease; box-shadow: 0 2px 7px rgba(0,0,0,.25); }
    .switch input:checked + .slider { background: linear-gradient(180deg, #22d3ee 0%, var(--teal) 80%); }
    .switch input:checked + .slider:before { transform: translateX(28px); }

    /* ===== Notif rows ===== */
    .notif-row { display: grid; grid-template-columns: 130px 1fr auto auto; gap: 10px; align-items: center; }
    .del { padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: #ffffff; cursor: pointer; }
    .chk { width: auto; }

    /* ===== Footer small ===== */
    .tiny { font-size: 12px; color: var(--muted); text-align: right; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header / Hero -->
    <section class="hero card">
      <h1>YQ_Notifi • Telegram 設定頁</h1>
    </section>

    <!-- 控制選擇：保留名稱 + 滑桿 -->
    <section class="card">
      <h3>控制輸出</h3>
      <div id="relays" class="grid"></div>
    </section>

    <!-- 推播設定 -->
    <section class="card">
      <div class="row" style="justify-content: space-between; align-items: baseline;">
        <h3>推播設定</h3>
        <span class="hint">選擇 GPIO 與訊息內容，可個別啟用/停用</span>
      </div>
      <div class="grid" id="notifs"></div>
      <div class="row">
        <button class="btn gray" id="addNotif">＋新增一組</button>
        <span class="spacer"></span>
        <span class="tiny" id="notifCountTip"></span>
      </div>
    </section>

    <!-- 動作按鈕 -->
    <section class="row">
      <button class="btn teal" id="save">💾 儲存設定</button>
      <button class="btn gray" id="close">關閉</button>
    </section>
  </div>

<script>
// === Telegram WebApp 物件（fallback 讓外部瀏覽器也能運作畫面） ===
const tg = (() => {
  try {
    if (window.Telegram && window.Telegram.WebApp) {
      const app = window.Telegram.WebApp;
      app.expand();
      return app;
    }
  } catch(e){}
  return { sendData: () => {}, close: () => {}, expand: () => {} };
})();

const LS_KEY = 'esp32_webapp_draft_v3';
const PINS   = [2,12,13,25,26,27,32,33];   // 可選 GPIO
const RELAY_COUNT = 4;                            // ✅ 改為 4 組
const NOTIF_MAX   = 8;                            // ✅ 最多 8 組

function loadState() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return {};
    return JSON.parse(raw) || {};
  } catch (_) { return {}; }
}
function saveState(s) {
  try { localStorage.setItem(LS_KEY, JSON.stringify(s)); } catch(_) {}
}
function escapeHtml(s='') {
  return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}

window.addEventListener('DOMContentLoaded', () => {
  const st = Object.assign(
    {
      relay_names: Array.from({length: RELAY_COUNT}, (_,i)=>`Relay ${i+1}`),
      relays: Array.from({length: RELAY_COUNT}, ()=>false),
      notifs: []
    },
    loadState()
  );

  // 保險：若舊資料長度不同，切齊到 4 組
  st.relay_names = (st.relay_names || []).slice(0, RELAY_COUNT);
  while (st.relay_names.length < RELAY_COUNT) st.relay_names.push(`Relay ${st.relay_names.length+1}`);
  st.relays = (st.relays || []).slice(0, RELAY_COUNT);
  while (st.relays.length < RELAY_COUNT) st.relays.push(false);
  st.notifs = Array.isArray(st.notifs) ? st.notifs.slice(0, NOTIF_MAX) : [];

  // === 渲染「控制 + 滑桿」 ===
  const $relays = document.getElementById('relays');
  if ($relays) {
    const rowHtml = (i) => `
      <div class="relay-row">
        <input type="text" class="rname" data-idx="${i}" placeholder="Relay ${i+1} 名稱" value="${escapeHtml(st.relay_names?.[i]||`Relay ${i+1}`)}">
        <label class="switch">
          <input type="checkbox" class="rtoggle" data-idx="${i}" ${st.relays?.[i] ? 'checked' : ''}>
          <span class="slider"></span>
        </label>
      </div>`;
    $relays.innerHTML = Array.from({length: RELAY_COUNT}, (_,i)=>rowHtml(i)).join('');

    $relays.addEventListener('change', (e) => {
      if (!e.target.matches('.rtoggle')) return;
      const idx = Number(e.target.dataset.idx);
      const state = !!e.target.checked;
      st.relays[idx] = state;
      saveState(st);
      tg.sendData(JSON.stringify({ type: 'relay', idx, state }));
    });

    $relays.addEventListener('input', (e) => {
      if (!e.target.matches('.rname')) return;
      const idx = Number(e.target.dataset.idx);
      st.relay_names[idx] = e.target.value;
      saveState(st);
    });
  }

  // === 推播設定 ===
  const $notifs = document.getElementById('notifs');
  const $addNotif = document.getElementById('addNotif');
  const $tip = document.getElementById('notifCountTip');

  function notifRowHTML(i, n) {
    const opts = PINS.map(p => `<option value="${p}" ${p===n.pin?'selected':''}>GPIO ${p}</option>`).join('');
    return `
      <div class="notif-row" data-i="${i}">
        <select class="npin">${opts}</select>
        <input class="nmsg" type="text" placeholder="推播訊息" value="${escapeHtml(n.msg||'')}">
        <label class="row" style="gap:6px">
          <input class="nen chk" type="checkbox" ${n.en!==false?'checked':''}> 啟用
        </label>
        <button class="del" title="刪除">✕</button>
      </div>`;
  }

  function renderNotifs() {
    if (!$notifs) return;
    $notifs.innerHTML = (st.notifs||[]).map((n,i)=>notifRowHTML(i,n)).join('');
    if ($tip) $tip.textContent = `已設定：${st.notifs.length} / ${NOTIF_MAX}`;
  }
  renderNotifs();

  $addNotif?.addEventListener('click', () => {
    if (st.notifs.length >= NOTIF_MAX) return;
    st.notifs.push({pin:13, msg:'', en:true});
    saveState(st); renderNotifs();
  });

  $notifs?.addEventListener('change', (e) => {
    const $row = e.target.closest('.notif-row'); if (!$row) return;
    const i = Number($row.dataset.i);
    if (e.target.classList.contains('npin'))  st.notifs[i].pin = Number(e.target.value);
    if (e.target.classList.contains('nen'))   st.notifs[i].en  = !!e.target.checked;
    saveState(st);
  });
  $notifs?.addEventListener('input', (e) => {
    const $row = e.target.closest('.notif-row'); if (!$row) return;
    const i = Number($row.dataset.i);
    if (e.target.classList.contains('nmsg')) st.notifs[i].msg = e.target.value;
    saveState(st);
  });
  $notifs?.addEventListener('click', (e) => {
    if (!e.target.classList.contains('del')) return;
    const i = Number(e.target.closest('.notif-row').dataset.i);
    st.notifs.splice(i,1);
    saveState(st); renderNotifs();
  });

  // === 儲存設定 ===
  document.getElementById('save')?.addEventListener('click', () => {
    saveState(st);
    const payload = {
      type: 'save_config',
      relay_names: st.relay_names,
      relays: st.relays,
      notifs: (st.notifs || []).map(n => ({ pin: Number(n.pin)||0, msg: n.msg || '', en: n.en !== false }))
    };
    tg.sendData(JSON.stringify(payload));
  });

  // === 關閉 ===
  document.getElementById('close')?.addEventListener('click', () => tg.close());
});
</script>
</body>
</html>
